#!/usr/bin/env bash

set -euo pipefail

get_platform() {
  local os arch

  os=$(uname -s)
  arch=$(uname -m)

  case "$os" in
    Linux)
      case "$arch" in
        x86_64) echo "x86_64-unknown-linux-gnu" ;;
        aarch64|arm64) echo "aarch64-unknown-linux-gnu" ;;
        *) echo "Unsupported architecture: $arch" >&2; exit 1 ;;
      esac
      ;;
    Darwin)
      case "$arch" in
        x86_64) echo "x86_64-apple-darwin" ;;
        arm64) echo "aarch64-apple-darwin" ;;
        *) echo "Unsupported architecture: $arch" >&2; exit 1 ;;
      esac
      ;;
    MINGW*|MSYS*|CYGWIN*)
      echo "x86_64-pc-windows-msvc"
      ;;
    *)
      echo "Unsupported OS: $os" >&2
      exit 1
      ;;
  esac
}

get_extension() {
  local os
  os=$(uname -s)

  case "$os" in
    MINGW*|MSYS*|CYGWIN*) echo "zip" ;;
    *) echo "tar.gz" ;;
  esac
}

download_binary() {
  local binary="$1"
  local version="$2"
  local platform="$3"
  local extension="$4"
  local download_path="$5"

  local url="https://github.com/cartridge-gg/vrf/releases/download/v${version}/${binary}-v${version}-${platform}.${extension}"

  echo "Downloading ${binary} from ${url}..."
  curl -fsSL "$url" -o "${download_path}/${binary}.${extension}"
}

main() {
  local version="${ASDF_INSTALL_VERSION:-}"
  local download_path="${ASDF_DOWNLOAD_PATH:-}"

  if [[ -z "$version" ]]; then
    echo "ASDF_INSTALL_VERSION is required" >&2
    exit 1
  fi

  if [[ -z "$download_path" ]]; then
    echo "ASDF_DOWNLOAD_PATH is required" >&2
    exit 1
  fi

  local platform extension
  platform=$(get_platform)
  extension=$(get_extension)

  mkdir -p "$download_path"

  download_binary "vrf-server" "$version" "$platform" "$extension" "$download_path"

  # Download checksums
  local checksums_url="https://github.com/cartridge-gg/vrf/releases/download/v${version}/checksums.txt"
  echo "Downloading checksums from ${checksums_url}..."
  curl -fsSL "$checksums_url" -o "${download_path}/checksums.txt"

  echo "Download completed successfully"
}

main "$@"
